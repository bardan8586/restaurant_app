{% extends "base.html" %}

{% block title %}Customer Portal - {{ super() }}{% endblock %}

{% block navigation %}
<div class="nav-tabs">
    <a href="#" class="nav-tab active" onclick="showTab('customer')">Customer Portal</a>
    {% if current_user.is_authenticated and current_user.is_staff() %}
        <a href="{{ url_for('admin_dashboard') }}" class="nav-tab">Admin Dashboard</a>
        <a href="{{ url_for('admin_tables') }}" class="nav-tab">Table Management</a>
    {% endif %}
</div>
{% endblock %}

{% block content %}
<h2>Make a Reservation</h2>
<div class="two-column">
    <div>
        <form id="reservationForm">
            <div class="form-group">
                <label for="customerFirstName">First Name *</label>
                <input type="text" id="customerFirstName" name="first_name" required>
            </div>
            
            <div class="form-group">
                <label for="customerLastName">Last Name *</label>
                <input type="text" id="customerLastName" name="last_name" required>
            </div>
            
            <div class="form-group">
                <label for="customerPhone">Phone *</label>
                <div style="display: flex; gap: 5px;">
                    <select id="countryCode" name="country_code" style="width: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="+1">ðŸ‡ºðŸ‡¸ +1 (US)</option>
                        <option value="+1">ðŸ‡¨ðŸ‡¦ +1 (CA)</option>
                        <option value="+44">ðŸ‡¬ðŸ‡§ +44 (UK)</option>
                        <option value="+33">ðŸ‡«ðŸ‡· +33 (FR)</option>
                        <option value="+49">ðŸ‡©ðŸ‡ª +49 (DE)</option>
                        <option value="+39">ðŸ‡®ðŸ‡¹ +39 (IT)</option>
                        <option value="+34">ðŸ‡ªðŸ‡¸ +34 (ES)</option>
                        <option value="+31">ðŸ‡³ðŸ‡± +31 (NL)</option>
                        <option value="+46">ðŸ‡¸ðŸ‡ª +46 (SE)</option>
                        <option value="+47">ðŸ‡³ðŸ‡´ +47 (NO)</option>
                        <option value="+45">ðŸ‡©ðŸ‡° +45 (DK)</option>
                        <option value="+41">ðŸ‡¨ðŸ‡­ +41 (CH)</option>
                        <option value="+43">ðŸ‡¦ðŸ‡¹ +43 (AT)</option>
                        <option value="+32">ðŸ‡§ðŸ‡ª +32 (BE)</option>
                        <option value="+351">ðŸ‡µðŸ‡¹ +351 (PT)</option>
                        <option value="+61">ðŸ‡¦ðŸ‡º +61 (AU)</option>
                        <option value="+64">ðŸ‡³ðŸ‡¿ +64 (NZ)</option>
                        <option value="+81">ðŸ‡¯ðŸ‡µ +81 (JP)</option>
                        <option value="+82">ðŸ‡°ðŸ‡· +82 (KR)</option>
                        <option value="+86">ðŸ‡¨ðŸ‡³ +86 (CN)</option>
                        <option value="+91">ðŸ‡®ðŸ‡³ +91 (IN)</option>
                        <option value="+55">ðŸ‡§ðŸ‡· +55 (BR)</option>
                        <option value="+52">ðŸ‡²ðŸ‡½ +52 (MX)</option>
                        <option value="+7">ðŸ‡·ðŸ‡º +7 (RU)</option>
                        <option value="+27">ðŸ‡¿ðŸ‡¦ +27 (ZA)</option>
                        <option value="+977">ðŸ‡³ðŸ‡µ +977 (NP)</option>
                    </select>
                    <input type="tel" id="customerPhone" name="phone" required placeholder="Enter phone number" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                <small class="help-text">Select country code and enter your phone number</small>
            </div>
            
            <div class="form-group">
                <label for="customerEmail">Email</label>
                <input type="email" id="customerEmail" name="email">
            </div>
            
            <div class="form-group">
                <label for="reservationDate">Date *</label>
                <input type="date" id="reservationDate" name="date" required>
                <small class="help-text">Select a date up to 30 days in advance</small>
            </div>
            
            <div class="form-group">
                <label for="reservationTime">Time *</label>
                <select id="reservationTime" name="time" required>
                    <option value="">Select Time</option>
                    <option value="17:00">5:00 PM</option>
                    <option value="17:30">5:30 PM</option>
                    <option value="18:00">6:00 PM</option>
                    <option value="18:30">6:30 PM</option>
                    <option value="19:00">7:00 PM</option>
                    <option value="19:30">7:30 PM</option>
                    <option value="20:00">8:00 PM</option>
                    <option value="20:30">8:30 PM</option>
                    <option value="21:00">9:00 PM</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="partySize">Party Size *</label>
                <select id="partySize" name="party_size" required>
                    <option value="">Select Size</option>
                    <option value="1">1 Person</option>
                    <option value="2">2 People</option>
                    <option value="3">3 People</option>
                    <option value="4">4 People</option>
                    <option value="5">5 People</option>
                    <option value="6">6 People</option>
                    <option value="7">7 People</option>
                    <option value="8">8 People</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="specialRequests">Special Requests</label>
                <textarea id="specialRequests" name="special_requests" rows="3" placeholder="Any special requests or notes..."></textarea>
            </div>
            
            <button type="submit" class="btn btn-primary" id="submitBtn">Check Availability & Book</button>
        </form>
    </div>
    
            <div>
            <h3>Available Tables</h3>
            <p><small>The first available table will be automatically selected for your reservation</small></p>
            <div id="availableTables" class="table-grid">
                <div class="loading">Select date, time, and party size to see available tables</div>
            </div>
        </div>
</div>

<div id="message"></div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    $('#reservationDate').attr('min', today);
    
    // Set maximum date to 30 days from now
    const maxDate = new Date();
    maxDate.setDate(maxDate.getDate() + 30);
    $('#reservationDate').attr('max', maxDate.toISOString().split('T')[0]);
    
    // Real-time system status
    checkSystemStatus();
    setInterval(checkSystemStatus, 30000); // Check every 30 seconds
    
    // Update available tables when date, time, or party size changes
    $('#reservationDate, #reservationTime, #partySize').on('change', function() {
        updateAvailableTables();
    });
    
    // Handle form submission
    $('#reservationForm').on('submit', function(e) {
        e.preventDefault();
        
        // Validate form first
        if (!validateForm()) {
            return;
        }
        
        const formData = {
            first_name: $('#customerFirstName').val(),
            last_name: $('#customerLastName').val(),
            phone: $('#countryCode').val() + ' ' + $('#customerPhone').val(),
            email: $('#customerEmail').val(),
            date: $('#reservationDate').val(),
            time: $('#reservationTime').val(),
            party_size: parseInt($('#partySize').val()),
            special_requests: $('#specialRequests').val()
        };
        
        // Validate required fields
        if (!formData.first_name || !formData.last_name || !formData.phone || 
            !formData.date || !formData.time || !formData.party_size) {
            showMessage('Please fill in all required fields.', 'error');
            return;
        }
        
        // Disable submit button
        $('#submitBtn').prop('disabled', true).text('Creating Reservation...');
        
        // Create reservation
        $.ajax({
            url: '/api/reservations',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                showMessage(
                    `Reservation successful! Table ${response.reservation.table.table_number} has been reserved for ${formData.first_name} ${formData.last_name} on ${formData.date} at ${formatTime(formData.time)}. Confirmation pending.`,
                    'success'
                );
                
                // Reset form
                $('#reservationForm')[0].reset();
                updateAvailableTables();
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                showMessage(response.error || 'An error occurred while creating the reservation.', 'error');
            },
            complete: function() {
                $('#submitBtn').prop('disabled', false).text('Check Availability & Book');
            }
        });
    });
});

function updateAvailableTables() {
    const date = $('#reservationDate').val();
    const time = $('#reservationTime').val();
    const partySize = $('#partySize').val();
    
    if (!date || !time || !partySize) {
        $('#availableTables').html('<div class="loading">Select date, time, and party size to see available tables</div>');
        return;
    }
    
    $('#availableTables').html('<div class="loading">Loading available tables...</div>');
    
    $.ajax({
        url: '/api/tables/available',
        method: 'GET',
        data: {
            date: date,
            time: time,
            party_size: partySize
        },
        success: function(response) {
            displayAvailableTables(response.available_tables);
        },
        error: function(xhr) {
            const response = xhr.responseJSON;
            $('#availableTables').html(`<div class="error-message">${response.error || 'Error loading tables'}</div>`);
        }
    });
}

function displayAvailableTables(tables) {
    const container = $('#availableTables');
    
    if (tables.length === 0) {
        container.html('<div class="error-message">No tables available for the selected date, time, and party size. Please try a different time.</div>');
        return;
    }
    
    let html = '';
    tables.forEach(function(table, index) {
        const isFirst = index === 0;
        html += `
            <div class="table-card available ${isFirst ? 'selected' : ''}" data-table-id="${table.table_id}">
                <h4>Table ${table.table_number} ${isFirst ? 'ðŸ‘‘ SELECTED' : ''}</h4>
                <p>Capacity: ${table.capacity} people</p>
                <p>Location: ${table.location || 'Not specified'}</p>
                <p>Status: ${isFirst ? 'Will be reserved for you' : 'Available'}</p>
            </div>
        `;
    });
    
    container.html(html);
}

function showMessage(message, type) {
    const messageDiv = $('#message');
    const alertClass = type === 'success' ? 'success-message' : 'error-message';
    messageDiv.html(`<div class="${alertClass}">${message}</div>`);
    
    // Auto-hide after 5 seconds
    setTimeout(function() {
        messageDiv.html('');
    }, 5000);
    
    // Scroll to message
    messageDiv[0].scrollIntoView({ behavior: 'smooth' });
}

function formatTime(timeStr) {
    const [hours, minutes] = timeStr.split(':');
    const hour = parseInt(hours);
    const ampm = hour >= 12 ? 'PM' : 'AM';
    const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
    return `${displayHour}:${minutes} ${ampm}`;
}

function showTab(tabName) {
    // This function is kept for compatibility but not used in this template
    // since we're using separate routes for different sections
}

function checkSystemStatus() {
    $.ajax({
        url: '/api/tables/available',
        method: 'GET',
        data: {
            date: new Date().toISOString().split('T')[0],
            time: '19:00',
            party_size: 2
        },
        timeout: 5000,
        success: function() {
            $('#systemStatus').text('ðŸŸ¢ Online').removeClass('offline');
        },
        error: function() {
            $('#systemStatus').text('ðŸ”´ Offline').addClass('offline');
        }
    });
}

// Table selection simplified - first available table is auto-selected

function validateForm() {
    const phone = $('#customerPhone').val().trim();
    
    if (phone.length < 5) {
        showMessage('Please enter a valid phone number (minimum 5 digits)', 'error');
        return false;
    }
    
    // Basic phone number validation (digits, spaces, dashes, parentheses)
    const phoneRegex = /^[\d\s\-\(\)\+\.]+$/;
    if (!phoneRegex.test(phone)) {
        showMessage('Please enter a valid phone number (numbers only)', 'error');
        return false;
    }
    
    const date = new Date($('#reservationDate').val());
    const today = new Date();
    const maxDate = new Date();
    maxDate.setDate(today.getDate() + 30);
    
    if (date < today || date > maxDate) {
        showMessage('Please select a date within the next 30 days', 'error');
        return false;
    }
    
    return true;
}
</script>
{% endblock %}
